// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  name          String?
  password      String?        // bcrypt hash for admin users
  role          String         @default("USER") // USER, VIEWER, ADMIN, DEV
  lastLoginAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Premium subscription fields
  plan              String?        @default("free") // "free", "basic", "premium", "pro"
  subscriptionId    String?        // Stripe subscription ID
  subscriptionEnd   DateTime?      // Subscription expiry date

  // Waiting list tracking
  waitingListStatus String?        // "waiting_list", "contacted", "converted"
  waitingListDate   DateTime?      // Date joined waiting list
  rsvpInterest      String?        // Interest level or notes

  // Password recovery (security question method)
  securityQuestion  String?
  securityAnswer    String?        // Hashed answer

  savedSearches SavedSearch[]
  savedTenders  SavedTender[]
  alertLogs     AlertLog[]
  auditLogs     AuditLog[]
  preferences   UserPreferences?
  tenderPacks   TenderPack[]
  waitingListEntry WaitingListEntry?
}

model SavedTender {
  id        String   @id @default(uuid())
  userId    String
  tenderId  String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tender Tender @relation(fields: [tenderId], references: [id], onDelete: Cascade)

  @@unique([userId, tenderId])
  @@index([userId])
  @@index([tenderId])
  @@index([createdAt])
}

model SavedSearch {
  id                   String    @id @default(uuid())
  userId               String
  name                 String
  keywords             String?
  categories           String?   // JSON stringified array
  closingInDays        Int?
  submissionMethods    String?   // JSON stringified array
  buyer                String?
  status               String?
  alertFrequency       String    @default("none") // "none", "daily", "weekly"
  lastAlertSent        DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  alertLogs            AlertLog[]

  @@index([userId])
}

model AlertLog {
  id              String       @id @default(uuid())
  userId          String
  savedSearchId   String
  tendersFound    Int
  emailSent       Boolean      @default(false)
  error           String?
  createdAt       DateTime     @default(now())

  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  savedSearch     SavedSearch  @relation(fields: [savedSearchId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([savedSearchId])
  @@index([createdAt])
}

model OCDSRelease {
  id                   String    @id @default(uuid())
  ocid                 String    // Open Contracting ID
  releaseId            String    // Unique release ID (ocid + date)
  date                 DateTime  // Release date
  tag                  String    // JSON array stringified (e.g., ["tender", "award"])
  json                 String    // Full JSONB data (TEXT in SQLite, JSONB in Postgres)

  // Denormalized fields for fast queries
  buyerName            String?
  tenderTitle          String?
  tenderDisplayTitle   String?   // Human-readable title derived from description
  tenderDescription    String?
  mainCategory         String?   // mainProcurementCategory
  closingAt            DateTime? // Renamed from closingEndDate (tender.tenderPeriod.endDate)
  submissionMethods    String?   // JSON array stringified
  awardSuppliers       String?   // JSON array stringified
  status               String?   // tender status

  // Freshness timestamps for latest-first search
  publishedAt          DateTime? // release.date OR tender.tenderPeriod.startDate
  updatedAt            DateTime? // max(release.date, doc.dateModified/datePublished)

  // Enhanced fields from OCDS API (extracted from parties, tender details)
  tenderType           String?   // procurementMethodDetails or procurementMethod
  province             String?   // From buyer/procuringEntity address.region
  deliveryLocation     String?   // From deliveryLocations or items
  specialConditions    String?   // eligibilityCriteria or selectionCriteria
  contactPerson        String?   // From procuringEntity contactPoint.name
  contactEmail         String?   // From procuringEntity contactPoint.email
  contactTelephone     String?   // From procuringEntity contactPoint.telephone
  enquiryDeadline      DateTime? // From enquiryPeriod.endDate

  // Fields from HTML scraping (populated separately)
  briefingDate         String?   // Date of briefing session
  briefingTime         String?   // Time of briefing session
  briefingVenue        String?   // Venue for briefing session
  briefingMeetingLink  String?   // Online meeting link for briefing
  // Additional enrichment flags + documents
  hasBriefing          Boolean?
  briefingCompulsory   Boolean?
  detailedCategory     String?   // Detailed category from eTenders website (91 categories)
  enrichmentDocuments  Json?

  // Phase 2: Deep Filtering Enhancement Fields (December 2025)
  organOfStateType     String?   // Classified type: "Local Municipality", "National Department", "SOE", etc.
  hasESubmission       Boolean?  // Boolean flag for electronic submission capability
  estimatedValueMin    Float?    // Minimum estimated contract value (ZAR)
  estimatedValueMax    Float?    // Maximum estimated contract value (ZAR)
  documentCount        Int?      // Number of available tender documents
  hasDocuments         Boolean?  // Quick filter: has any documents
  city                 String?   // City/locality (extracted from delivery location or briefing venue)
  district             String?   // District (for municipalities - e.g., "Cape Winelands District")
  tenderTypeCategory   String?   // Normalized tender type: "RFQ", "RFP", "RFI", "EOI", etc.
  dataQualityScore     Int?      // 0-100 score based on field completeness
  municipalityType     String?   // For municipalities: "Local", "District", "Metro"
  departmentLevel      String?   // For departments: "National", "Provincial"

  // Performance optimization fields
  slug                 String?   @unique // SEO-friendly URL slug for fast lookups
  enrichedAt           DateTime? // Timestamp of last enrichment (for cache-first strategy)
  briefingFlags        Json?     // Cached briefing information from eTenders
  documentUrls         Json?     // Cached document URLs from eTenders

  // ETL metadata
  importedAt           DateTime  @default(now())
  lastModifiedAt       DateTime  @default(now()) @updatedAt // Prisma auto-update field

  @@unique([ocid, date])
  @@index([ocid])
  @@index([slug]) // Performance: Fast tender lookups by slug
  @@index([closingAt])
  @@index([mainCategory])
  @@index([status])
  @@index([buyerName])
  @@index([importedAt])
  @@index([publishedAt])
  @@index([updatedAt])
  @@index([province])
  @@index([tenderType])
  @@index([enquiryDeadline])
  @@index([detailedCategory])
  @@index([enrichedAt]) // Performance: Track enrichment freshness
  // Phase 2: Deep Filtering indexes
  @@index([organOfStateType])
  @@index([hasESubmission])
  @@index([estimatedValueMin])
  @@index([estimatedValueMax])
  @@index([documentCount])
  @@index([city])
  @@index([district])
  @@index([tenderTypeCategory])
  @@index([dataQualityScore])
  // Composite indexes for common query patterns (performance optimization)
  @@index([publishedAt(sort: Desc), mainCategory])
  @@index([status, closingAt(sort: Desc)])
  @@index([mainCategory, publishedAt(sort: Desc)])
  @@index([province, status])
  @@index([tenderType, closingAt(sort: Desc)])
  @@index([organOfStateType, province])
  @@index([estimatedValueMin, estimatedValueMax])
  @@index([detailedCategory, organOfStateType])
}

// Admin Console Models

model AuditLog {
  id          String    @id @default(uuid())
  userId      String
  action      String    // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entity      String?   // What was changed (Config, JobLog, etc.)
  entityId    String?   // ID of the entity
  before      String?   // JSON snapshot before change
  after       String?   // JSON snapshot after change
  metadata    String?   // JSON: { ip, userAgent, etc. }
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
}

model JobLog {
  id          String    @id @default(uuid())
  type        String    // DOWNLOAD, IMPORT, SYNC, REINDEX
  status      String    // PENDING, RUNNING, SUCCESS, FAILED
  startedAt   DateTime  @default(now())
  finishedAt  DateTime?
  note        String?   // Error message or summary
  metadata    String?   // JSON: { year, recordsProcessed, etc. }

  @@index([type])
  @@index([status])
  @@index([startedAt])
}

model SearchLog {
  id          String    @id @default(uuid())
  keywords    String?
  filters     String?   // JSON
  duration    Int       // milliseconds
  dataSource  String    // local-db or live-api
  resultsCount Int
  createdAt   DateTime  @default(now())

  @@index([createdAt])
}

model ErrorLog {
  id          String    @id @default(uuid())
  path        String
  method      String
  statusCode  Int
  message     String
  stack       String?
  metadata    String?   // JSON: { userId, ip, etc. }
  createdAt   DateTime  @default(now())

  @@index([statusCode])
  @@index([createdAt])
}

model MailLog {
  id          String    @id @default(uuid())
  to          String
  subject     String
  status      String    // SENT, FAILED
  error       String?
  isTest      Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@index([status])
  @@index([createdAt])
}

model Config {
  id          String    @id @default(uuid())
  key         String    @unique
  value       String    // JSON value
  updatedAt   DateTime  @updatedAt
}

// Intelligence Tables

model BuyerStats {
  id                     String    @id @default(uuid())
  buyerName              String    @unique
  awards24m              Int       @default(0)
  avgAwardZAR            Float?
  amendmentRate          Float?    // Proxy from releases with "amendment" tags
  contractOverrunRate    Float?    // Proxy metric
  computedAt             DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  @@index([buyerName])
  @@index([computedAt])
}

model CategoryStats {
  id              String    @id @default(uuid())
  category        String    @unique
  p25ZAR          Float?
  p50ZAR          Float?
  p75ZAR          Float?
  marginLow       Float?    // Editable margin bands
  marginHigh      Float?
  computedAt      DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([category])
  @@index([computedAt])
}

model SupplierStats {
  id              String    @id @default(uuid())
  supplierName    String    @unique
  wins6m          Int       @default(0)
  winsPrev6m      Int       @default(0)
  wins24m         Int       @default(0)
  topBuyers       String?   // JSON array of buyer names
  computedAt      DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([supplierName])
  @@index([computedAt])
}

model TenderFeatures {
  id                  String    @id @default(uuid())
  ocid                String    @unique
  displayTitle        String?
  rfqCode             String?   // Extracted RFQ/RFP code
  estValueZAR         Float?
  estValueBand        String?   // JSON: {low, mid, high}
  profitMidZAR        Float?
  competitionHHI      Float?    // Herfindahl index (0-1)
  opportunityScore    Int?      // 0-100
  scoreConfidence     Float?    // 0-1
  scoreFactors        String?   // JSON: breakdown of OpportunityScore factors
  relatedOcids        String?   // JSON array of related OCIDs (TF-IDF)
  dataQualityScore    Int?      // 0-100
  dataQualityDetails  String?   // JSON: list of missing fields
  computedAt          DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([ocid])
  @@index([opportunityScore])
  @@index([computedAt])
}

model DocSummary {
  id              String    @id @default(uuid())
  ocid            String
  docId           String    // Document ID from OCDS or URL hash
  docUrl          String?
  docTitle        String?
  source          String    @default("puter") // "puter" or "stub"
  mustHaves       String?   // JSON array of must-have requirements
  scoring         String?   // JSON array of scoring criteria
  risks           String?   // JSON array of risk factors
  deadlines       String?   // JSON array of deadline info
  fullSummary     String?   // Full text summary
  confidence      Float?
  processedAt     DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([ocid, docId])
  @@index([ocid])
  @@index([processedAt])
}

model DocRegistry {
  id              String    @id @default(uuid())
  docId           String    @unique  // Hash of original URL
  ocid            String?              // Associated tender OCID
  originalUrl     String               // Original document URL
  title           String?              // Document title
  mimeType        String?              // e.g., "application/pdf"
  sizeBytes       Int?                 // File size
  fetchedAt       DateTime  @default(now())
  lastAccessedAt  DateTime  @default(now())
  accessCount     Int       @default(0)
  localPath       String?              // Path to cached file (if we cache locally)
  status          String    @default("available") // "available", "fetching", "failed"
  errorMessage    String?              // If fetch failed

  @@index([docId])
  @@index([ocid])
  @@index([fetchedAt])
}

model VerificationRegistry {
  id              String    @id @default(uuid())
  ocid            String    @unique  // OCID being verified
  sourceHash      String               // SHA-256 hash of core fields
  publisher       String               // e.g., "etenders.gov.za"
  sourceUrl       String?              // Original source URL
  lastSeenAt      DateTime  @default(now()) // Last time seen in live feed
  firstSeenAt     DateTime  @default(now()) // First time seen
  status          String    @default("verified") // "verified", "synced", "stale"
  checkCount      Int       @default(1) // Number of times checked
  updatedAt       DateTime  @updatedAt

  @@index([ocid])
  @@index([lastSeenAt])
  @@index([status])
}

model SyncState {
  id            String   @id @default("ocds_etenders_sa")
  lastRunAt     DateTime?
  lastSuccessAt DateTime?
  lastCursor    String?      // If upstream supports pagination cursors
  lastSyncedDate DateTime?   // Last date we synced up to
  notes         String?
  updatedAt     DateTime @updatedAt
}

model DeltaSyncState {
  id               String   @id @default("ocds_etenders_sa_delta")
  lastRunAt        DateTime?
  lastSuccessAt    DateTime?
  lastReleaseSeen  DateTime?   // max(release.date) we successfully processed
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ============================================================================
// BRONZE LAYER - Raw immutable data
// ============================================================================

model RawRelease {
  id         String   @id // release.id from OCDS
  ocid       String
  date       DateTime
  tag        String   // JSON stringified array
  json       String   // Full raw release JSON
  source     String?  // Dataset name/url (e.g., "etenders.gov.za", "2025.jsonl")
  createdAt  DateTime @default(now())

  @@unique([ocid, date])
  @@index([ocid])
  @@index([date])
  @@index([source])
  @@index([createdAt])
}

// ============================================================================
// SILVER LAYER - Normalized OCDS entities
// ============================================================================

model Ocid {
  ocid           String   @id
  firstDate      DateTime?
  lastDate       DateTime?
  language       String?
  initiationType String?  // tender, award, contract, etc.
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([lastDate])
  @@index([initiationType])
}

model Party {
  id         String   @id @default(uuid())
  ocid       String
  partyId    String?  // parties[i].id from OCDS
  name       String?
  roles      String   // JSON stringified array (buyer, supplier, procuringEntity, etc.)
  legalName  String?
  email      String?
  phone      String?
  url        String?
  country    String?
  region     String?
  locality   String?
  address    String?  // Full address text
  createdAt  DateTime @default(now())

  @@unique([ocid, partyId, roles]) // Allow same party with different roles
  @@index([ocid])
  @@index([partyId])
  @@index([name])
  @@index([roles])
}

model Tender {
  id                              String    @id @default(uuid())
  ocid                            String
  tenderId                        String?
  title                           String?
  description                     String?
  mainProcurementCategory         String?
  additionalProcurementCategories String?   // JSON stringified array
  procurementMethod               String?
  procurementMethodDetails        String?
  submissionMethod                String?   // JSON stringified array
  submissionMethodDetails         String?
  startDate                       DateTime?
  endDate                         DateTime?
  status                          String?
  valueAmount                     Float?
  valueCurrency                   String?
  createdAt                       DateTime  @default(now())

  // Relations
  savedTenders    SavedTender[]
  tenderPackItems TenderPackTender[]

  @@unique([ocid, tenderId])
  @@index([ocid])
  @@index([endDate])
  @@index([status])
  @@index([mainProcurementCategory])
  @@index([startDate])
}

model TenderItem {
  id                   String   @id @default(uuid())
  ocid                 String
  tenderId             String?
  itemId               String?
  description          String?
  classificationId     String?
  classificationScheme String?
  quantity             Float?
  unitName             String?
  unitValue            Float?   // Per-unit value if available
  createdAt            DateTime @default(now())

  @@unique([ocid, tenderId, itemId])
  @@index([ocid])
  @@index([tenderId])
  @@index([classificationId])
}

model Document {
  id            String    @id @default(uuid())
  ocid          String
  parent        String    // 'tender' | 'award' | 'contract' | 'planning' | 'implementation'
  parentId      String?   // tenderId, awardId, contractId, etc.
  docId         String?   // Document ID from OCDS
  title         String?
  url           String?
  datePublished DateTime?
  dateModified  DateTime?
  format        String?   // pdf, docx, etc.
  language      String?
  documentType  String?   // tenderNotice, awardNotice, etc.
  description   String?
  createdAt     DateTime  @default(now())

  @@unique([ocid, parent, parentId, docId])
  @@index([ocid])
  @@index([parent])
  @@index([parentId])
  @@index([datePublished])
}

model Award {
  id            String    @id @default(uuid())
  ocid          String
  awardId       String?
  title         String?
  description   String?
  date          DateTime?
  status        String?
  valueAmount   Float?
  valueCurrency String?
  createdAt     DateTime  @default(now())

  @@unique([ocid, awardId])
  @@index([ocid])
  @@index([awardId])
  @@index([date])
  @@index([status])
}

model AwardSupplier {
  id           String   @id @default(uuid())
  ocid         String
  awardId      String?
  supplierId   String?
  supplierName String?
  legalName    String?
  createdAt    DateTime @default(now())

  @@unique([ocid, awardId, supplierId])
  @@index([ocid])
  @@index([awardId])
  @@index([supplierName])
}

model Contract {
  id            String    @id @default(uuid())
  ocid          String
  contractId    String?
  awardId       String?
  title         String?
  status        String?
  dateSigned    DateTime?
  periodStart   DateTime?
  periodEnd     DateTime?
  valueAmount   Float?
  valueCurrency String?
  createdAt     DateTime  @default(now())

  @@unique([ocid, contractId])
  @@index([ocid])
  @@index([awardId])
  @@index([contractId])
  @@index([dateSigned])
  @@index([status])
}

model Milestone {
  id          String    @id @default(uuid())
  ocid        String
  parent      String    // 'tender' | 'contract' | 'implementation'
  parentId    String?
  milestoneId String?
  title       String?
  dueDate     DateTime?
  dateMet     DateTime?
  status      String?
  description String?
  createdAt   DateTime  @default(now())

  @@unique([ocid, parent, parentId, milestoneId])
  @@index([ocid])
  @@index([parent])
  @@index([parentId])
  @@index([dueDate])
}

model ImplementationTx {
  id            String    @id @default(uuid())
  ocid          String
  contractId    String?
  txId          String?
  date          DateTime?
  valueAmount   Float?
  valueCurrency String?
  payer         String?
  payee         String?
  createdAt     DateTime  @default(now())

  @@unique([ocid, contractId, txId])
  @@index([ocid])
  @@index([contractId])
  @@index([date])
}

model Planning {
  id                String   @id @default(uuid())
  ocid              String   @unique
  budgetDescription String?
  budgetAmount      Float?
  budgetCurrency    String?
  rationale         String?
  createdAt         DateTime @default(now())

  @@index([ocid])
}

// ============================================================================
// GOLD LAYER - Facts & Dimensions for analytics
// ============================================================================

model DimBuyer {
  id            String   @id @default(uuid())
  name          String
  nameCanonical String   @unique
  country       String?
  region        String?
  sourceCount   Int      @default(0) // How many raw aliases map to this
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([nameCanonical])
  @@index([country])
}

model DimSupplier {
  id            String   @id @default(uuid())
  name          String
  nameCanonical String   @unique
  country       String?
  sourceCount   Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([nameCanonical])
  @@index([country])
}

model BuyerAlias {
  id        String   @id @default(uuid())
  alias     String
  canonical String
  createdAt DateTime @default(now())

  @@unique([alias])
  @@index([canonical])
}

model SupplierAlias {
  id        String   @id @default(uuid())
  alias     String
  canonical String
  createdAt DateTime @default(now())

  @@unique([alias])
  @@index([canonical])
}

model FactTender {
  ocid            String   @id
  buyerCanonical  String?
  category        String?
  method          String?
  startDate       DateTime?
  endDate         DateTime?
  docCount        Int      @default(0)
  itemCount       Int      @default(0)
  hasAwards       Boolean  @default(false)
  hasContracts    Boolean  @default(false)
  valueAmount     Float?
  valueCurrency   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([buyerCanonical])
  @@index([category])
  @@index([endDate])
  @@index([startDate])
}

model FactAward {
  id                String    @id @default(uuid())
  ocid              String
  awardId           String?
  valueAmount       Float?
  valueCurrency     String?
  date              DateTime?
  supplierCanonical String?
  buyerCanonical    String?
  createdAt         DateTime  @default(now())

  @@unique([ocid, awardId])
  @@index([ocid])
  @@index([supplierCanonical])
  @@index([buyerCanonical])
  @@index([date])
}

model FactContract {
  id            String    @id @default(uuid())
  ocid          String
  contractId    String?
  awardId       String?
  valueAmount   Float?
  valueCurrency String?
  dateSigned    DateTime?
  durationDays  Int?
  createdAt     DateTime  @default(now())

  @@unique([ocid, contractId])
  @@index([ocid])
  @@index([dateSigned])
}

model TimelineEvent {
  id        String   @id @default(uuid())
  ocid      String
  date      DateTime
  type      String   // 'deadline_changed' | 'doc_added' | 'doc_removed' | 'award_added' | etc.
  payload   String   // JSON
  createdAt DateTime @default(now())

  @@index([ocid])
  @@index([date])
  @@index([type])
}

// ============================================================================
// FEATURE STORE - ML-ready features
// ============================================================================

model FsTenderFeatures {
  ocid                 String    @id
  displayTitle         String?
  textEmbed384         String?   // JSON stringified Float[] for embeddings (384d MiniLM)
  estValueZAR          Float?
  valueBandLowZAR      Float?
  valueBandHighZAR     Float?
  paymentReliability   Int?      // 0-100 score
  competitionHHI       Float?    // 0-1 Herfindahl index
  relatedOcids         String?   // JSON array of similar tender OCIDs
  opportunityScore     Int?      // 0-100
  dataQualityScore     Int?      // 0-100
  dataQualityDetails   String?   // JSON: missing fields
  updatedAt            DateTime  @updatedAt

  @@index([opportunityScore])
  @@index([dataQualityScore])
  @@index([updatedAt])
}

// ============================================================================
// DATA QUALITY
// ============================================================================

model DataQualityCheck {
  id          String   @id @default(uuid())
  checkType   String   // 'FK_INTEGRITY' | 'DATE_SANITY' | 'DUPLICATE_IDS' | 'MISSING_CRITICAL'
  status      String   // 'PASS' | 'FAIL' | 'WARN'
  message     String?
  metadata    String?  // JSON: details of failures
  recordCount Int?     // Number of records checked
  failCount   Int?     // Number of failures
  runAt       DateTime @default(now())

  @@index([checkType])
  @@index([status])
  @@index([runAt])
}

// ============================================================================
// USER PREFERENCES & TENDER PACKS
// ============================================================================

model UserPreferences {
  id                    String   @id @default(uuid())
  userId                String   @unique
  defaultSearchFilters  String?  // JSON: saved search preferences
  notificationSettings  String?  // JSON: email, SMS, push preferences
  dashboardLayout       String?  // JSON: widget configuration
  theme                 String?  @default("light") // light, dark, auto
  language              String?  @default("en")
  timezone              String?  @default("Africa/Johannesburg")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TenderPack {
  id          String   @id @default(uuid())
  name        String
  description String?
  userId      String
  isPublic    Boolean  @default(false)
  tenderCount Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenders TenderPackTender[]

  @@index([userId])
  @@index([isPublic])
  @@index([createdAt])
}

model TenderPackTender {
  id       String @id @default(uuid())
  packId   String
  tenderId String

  pack   TenderPack @relation(fields: [packId], references: [id], onDelete: Cascade)
  tender Tender     @relation(fields: [tenderId], references: [id], onDelete: Cascade)

  @@unique([packId, tenderId])
  @@index([packId])
  @@index([tenderId])
}

// ============================================================================
// AI PROCESSING & DOCUMENTS
// ============================================================================

model AIDocumentProcessing {
  id              String   @id @default(uuid())
  documentId      String
  provider        String   // 'google-document-ai', 'vertex-ai', 'puter'
  processingType  String   // 'extract', 'analyze', 'summarize'
  status          String   // 'pending', 'processing', 'completed', 'failed'
  result          String?  // JSON: processing results
  error           String?  // Error message if failed
  confidence      Float?   // Processing confidence score
  processingTime  Int?     // Processing time in milliseconds
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([documentId])
  @@index([provider])
  @@index([status])
  @@index([createdAt])
}

model PuterDocument {
  id          String   @id @default(uuid())
  puterFileId String   @unique
  userId      String?
  category    String?
  metadata    String?  // JSON: additional metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([category])
  @@index([createdAt])
}
model Feedback {
  id          String   @id @default(uuid())
  type        String   // "feature" | "bug" | "improvement" | "feedback"
  title       String
  description String   @db.Text
  email       String?
  priority    String   @default("medium") // "low" | "medium" | "high" | "critical"
  status      String   @default("pending") // "pending" | "reviewing" | "planned" | "in-progress" | "completed" | "rejected"
  votes       Int      @default(0)
  userAgent   String?  // Track if mobile/desktop
  ipAddress   String?  // For spam prevention
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([priority])
}

model PlatformConfig {
  id        String   @id @default(uuid())
  key       String   @unique // e.g., "notificationBar", "maintenanceMode", etc.
  value     Json?    // Flexible JSON storage for configuration values
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

model ContactSubmission {
  id        String   @id @default(uuid())
  name      String
  email     String
  subject   String
  message   String   @db.Text
  status    String   @default("unread") // "unread" | "read" | "replied" | "spam"
  ipAddress String?  // For spam prevention and tracking
  userAgent String?  // Browser/device information
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([email])
}

model WaitingListEntry {
  id            String   @id @default(uuid())
  userId        String?  @unique
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Captured data
  name          String
  email         String   @unique
  company       String?
  phoneNumber   String?
  jobTitle      String?
  interest      String?  // "high", "medium", "low"
  message       String?  @db.Text

  // Tracking
  status        String   @default("pending") // "pending", "contacted", "converted", "declined"
  source        String   @default("tender-page") // Where they signed up
  referrer      String?  // UTM or referrer

  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  contactedAt   DateTime?
  convertedAt   DateTime?

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

// ============================================================================
// PHASE 3: FUNDING DISCOVERY ENGINE
// ============================================================================

model FundingOpportunity {
  id               String   @id @default(cuid())
  source           String   // "pdf" | "idc" | "sefa" | "nef" | "corporate_esd"
  institution      String
  programName      String
  slug             String   @unique
  fundingType      String   // "Grant" | "Loan" | "Equity" | "Hybrid"
  minAmount        BigInt?  // cents or ZAR integer (using BigInt for large amounts)
  maxAmount        BigInt?
  amountNotes      String?
  categories       String[] // Array of categories
  provinces        String[] // Array of provinces
  eligibility      String[] // Array of eligibility criteria
  fundedIndustries String[] // Array of funded industries
  purpose          String?
  applyUrl         String?
  contacts         Json?    // Contact information (email, phone, address)

  // Enhanced fields for Corporate ESD and detailed information
  contactPerson    String?      // Specific contact person name
  contactPhone     String?      // Direct phone number
  contactEmail     String?      // Direct email address
  website          String?      // Institution website
  applicationMethod String?     // How to apply (online, email, portal, etc.)
  submissionRequirements String[] @default([]) // Array of required documents
  fundingCategory  String?      // "Corporate ESD" | "Government" | "DFI" | "Private"
  parentInstitution String?     // For sub-programs (e.g., "FNB" for Vumela programs)
  sector           String?      // Primary sector focus
  deadline         DateTime?    // Application deadline if applicable

  lastSeenAt       DateTime @updatedAt
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  searchableText   String   @db.Text // Full-text search field
  isActive         Boolean  @default(true)

  savedFunding     SavedFunding[]

  @@index([source])
  @@index([slug])
  @@index([categories])
  @@index([provinces])
  @@index([fundingType])
  @@index([fundingCategory])
  @@index([sector])
  @@index([isActive])
  @@index([minAmount])
  @@index([maxAmount])
}

model SavedFunding {
  id        String   @id @default(cuid())
  userId    String
  fundingId String
  note      String?
  status    String?  // "saved" | "applied" | "awarded" | "rejected"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  funding   FundingOpportunity @relation(fields: [fundingId], references: [id], onDelete: Cascade)

  @@unique([userId, fundingId])
  @@index([userId])
  @@index([fundingId])
  @@index([createdAt])
}

model FundingSearch {
  id         String   @id @default(cuid())
  userId     String
  filters    Json     // Search filter criteria
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}
